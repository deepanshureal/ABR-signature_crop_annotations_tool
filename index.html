<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Annotation Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #1e1e1e;
            color: #ffffff;
            height: 100vh;
            overflow: hidden;
        }

        .main-container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 300px;
            background-color: #252525;
            border-right: 1px solid #444;
            overflow-y: auto;
            padding: 20px;
        }

        .sidebar h3 {
            color: #4CAF50;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .file-list {
            list-style: none;
        }

        .file-item {
            padding: 8px 12px;
            margin-bottom: 4px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            transition: background-color 0.2s;
        }

        .file-item:hover {
            background-color: #333;
        }

        .file-item.active {
            background-color: #3a3a3a;
            border-left: 3px solid #4CAF50;
        }

        .file-item.processed {
            color: #4CAF50;
        }

        .file-item.unprocessed {
            color: #aaa;
        }

        .file-status {
            margin-left: auto;
            font-size: 12px;
        }

        .file-status.processed {
            color: #4CAF50;
        }

        .stats-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #444;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .stat-label {
            color: #888;
        }

        .stat-value {
            color: #fff;
            font-weight: bold;
        }

        .container {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding: 20px;
            overflow: hidden;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #444;
            margin-bottom: 10px;
        }

        .folder-info {
            display: flex;
            gap: 30px;
            padding: 10px;
            background-color: #2a2a2a;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 13px;
        }

        .folder-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .folder-label {
            color: #888;
        }

        .folder-path {
            color: #4CAF50;
            font-family: monospace;
        }

        .folder-path.not-selected {
            color: #666;
            font-style: italic;
        }

        .header h1 {
            font-size: 24px;
            color: #4CAF50;
        }

        .image-info {
            display: flex;
            gap: 20px;
            font-size: 14px;
            color: #aaa;
        }

        .image-viewer {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #2a2a2a;
            border-radius: 8px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }

        #current-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            display: none;
        }

        #no-image-message {
            color: #666;
            font-size: 18px;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        button {
            padding: 10px 20px;
            background-color: #607D8B;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        button:hover:not(:disabled) {
            background-color: #455A64;
        }

        button:disabled {
            background-color: #555;
            cursor: not-allowed;
            opacity: 0.6;
        }

        #prev-btn, #next-btn {
            background-color: #4CAF50;
        }

        #prev-btn:hover:not(:disabled), #next-btn:hover:not(:disabled) {
            background-color: #45a049;
        }

        #load-images-btn {
            background-color: #2196F3;
        }

        #load-images-btn:hover {
            background-color: #0b7dda;
        }

        #load-unannotated-btn {
            background-color: #009688;
        }

        #load-unannotated-btn:hover {
            background-color: #00796B;
        }


        #save-btn {
            background-color: #ff9800;
            padding: 15px 30px;
            font-size: 16px;
            font-weight: bold;
            margin-left: auto;
        }

        #save-btn:hover:not(:disabled) {
            background-color: #e68900;
        }



        .output-folder-info {
            text-align: center;
            color: #4CAF50;
            font-size: 12px;
            margin-top: 5px;
        }

        .text-inputs {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .input-group {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            margin-bottom: 8px;
            font-size: 16px;
            color: #aaa;
            font-weight: 500;
        }

        .input-group textarea {
            padding: 20px;
            background-color: #2a2a2a;
            color: white;
            border: 1px solid #444;
            border-radius: 4px;
            resize: vertical;
            min-height: 180px;
            font-family: inherit;
            font-size: 20px;
            line-height: 1.6;
        }

        .input-group textarea:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .status-bar {
            padding: 10px;
            background-color: #2a2a2a;
            border-radius: 4px;
            text-align: center;
            font-size: 14px;
            color: #aaa;
        }

        #status-message {
            transition: color 0.3s;
        }

        #status-message.success {
            color: #4CAF50;
        }

        #status-message.error {
            color: #f44336;
        }

        .processed-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #4CAF50;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="sidebar">
            <h3>üìÅ Files</h3>
            <ul id="file-list" class="file-list">
                <!-- Files will be populated here -->
            </ul>
            
            <div class="stats-section">
                <h3>üìä Progress</h3>
                <div class="stat-item">
                    <span class="stat-label">Total Images:</span>
                    <span class="stat-value" id="stat-total">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Processed:</span>
                    <span class="stat-value" id="stat-processed" style="color: #4CAF50;">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Remaining:</span>
                    <span class="stat-value" id="stat-remaining" style="color: #ff9800;">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Progress:</span>
                    <span class="stat-value" id="stat-progress">0%</span>
                </div>
            </div>
        </div>
        
        <div class="container">
        <div class="header">
            <h1>Image Annotation Tool</h1>
            <div class="image-info">
                <span id="current-image-name">No image loaded</span>
                <span id="image-counter">0 / 0</span>
                <span id="processed-counter">Processed: 0</span>
            </div>
        </div>
        
        <div class="folder-info">
            <div class="folder-item">
                <span class="folder-label">üìÅ Input:</span>
                <span id="input-folder-path" class="folder-path not-selected">No folder selected</span>
            </div>
            <div class="folder-item">
                <span class="folder-label">üíæ Output:</span>
                <span id="output-folder-path" class="folder-path not-selected">No folder selected</span>
            </div>
        </div>
        
        <div class="image-viewer">
            <img id="current-image" src="" alt="Current image">
            <div id="no-image-message">No image loaded. Click "Select Image Folder" to start.</div>
            <div id="processed-indicator" class="processed-indicator" style="display: none;">‚úì Processed</div>
        </div>
        
        <div class="controls">
            <button id="prev-btn" disabled>‚Üê Previous (P)</button>
            <button id="load-images-btn">Load All Images</button>
            <button id="load-unannotated-btn">Load Unannotated Only</button>
            <button id="next-btn" disabled>Next (N) ‚Üí</button>
            <button id="save-btn" disabled>Save & Mark Complete (Enter)</button>
        </div>
        
        <div class="text-inputs">
            <div class="input-group">
                <label for="text-input">Text Content:</label>
                <textarea id="text-input" placeholder="Enter text content here..."></textarea>
            </div>
            <div class="input-group">
                <label for="date-input">Date/Time:</label>
                <textarea id="date-input" placeholder="Enter date/time here (e.g., 05/15/243 10:00 AM)"></textarea>
            </div>
        </div>
        
        <div class="status-bar">
            <span id="status-message">Ready - Select a folder with JPG images to begin</span>
        </div>
        </div>
    </div>
    
    
    <script>
        let images = [];
        let currentImageIndex = 0;
        let annotations = {};
        let processedImages = new Set();
        let outputDirectoryHandle = null;
        let inputDirectoryHandle = null;
        let allImages = [];

        const imageViewer = document.getElementById('current-image');
        const noImageMessage = document.getElementById('no-image-message');
        const currentImageName = document.getElementById('current-image-name');
        const imageCounter = document.getElementById('image-counter');
        const processedCounter = document.getElementById('processed-counter');
        const processedIndicator = document.getElementById('processed-indicator');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const saveBtn = document.getElementById('save-btn');
        const loadImagesBtn = document.getElementById('load-images-btn');
        const loadUnannotatedBtn = document.getElementById('load-unannotated-btn');
        const textInput = document.getElementById('text-input');
        const dateInput = document.getElementById('date-input');
        const statusMessage = document.getElementById('status-message');
        const fileList = document.getElementById('file-list');
        const statTotal = document.getElementById('stat-total');
        const statProcessed = document.getElementById('stat-processed');
        const statRemaining = document.getElementById('stat-remaining');
        const statProgress = document.getElementById('stat-progress');
        const inputFolderPath = document.getElementById('input-folder-path');
        const outputFolderPath = document.getElementById('output-folder-path');

        loadImagesBtn.addEventListener('click', async () => {
            await loadImagesFromFolder(false); // Load all images
        });

        loadUnannotatedBtn.addEventListener('click', async () => {
            await loadImagesFromFolder(true); // Load only unannotated images
        });

        async function loadImagesFromFolder(onlyUnannotated = false) {
            if (!('showDirectoryPicker' in window)) {
                setStatus('Your browser does not support folder selection. Please use Chrome or Edge.', 'error');
                return;
            }

            try {
                // Select input folder
                inputDirectoryHandle = await window.showDirectoryPicker();
                
                // Update input folder display
                inputFolderPath.textContent = inputDirectoryHandle.name;
                inputFolderPath.classList.remove('not-selected');
                
                // Use same folder for output (no subfolder needed now)
                if (!outputDirectoryHandle) {
                    outputDirectoryHandle = inputDirectoryHandle;
                    outputFolderPath.textContent = inputDirectoryHandle.name;
                    outputFolderPath.classList.remove('not-selected');
                }

                // Read all files in the directory
                allImages = [];
                const existingJsonFiles = new Set(); // Store JSON filenames
                const existingJsons = new Map(); // Store JSON content
                
                for await (const entry of inputDirectoryHandle.values()) {
                    if (entry.kind === 'file') {
                        const fileName = entry.name;
                        if (fileName.toLowerCase().endsWith('.jpg') || fileName.toLowerCase().endsWith('.jpeg')) {
                            const file = await entry.getFile();
                            allImages.push(file);
                        } else if (fileName.toLowerCase().endsWith('.json')) {
                            // Track JSON files
                            existingJsonFiles.add(fileName.toLowerCase());
                            // Load existing JSON content
                            try {
                                const file = await entry.getFile();
                                const content = await file.text();
                                const baseName = fileName.replace(/\.json$/i, '');
                                existingJsons.set(baseName, JSON.parse(content));
                            } catch (err) {
                                console.error('Error loading JSON:', fileName, err);
                            }
                        }
                    }
                }

                // Count total processed across all images
                let totalProcessedCount = 0;
                allImages.forEach(img => {
                    const jsonFileName = img.name.replace(/\.(jpg|jpeg)$/i, '.json').toLowerCase();
                    if (existingJsonFiles.has(jsonFileName)) {
                        totalProcessedCount++;
                    }
                });

                // Filter images based on whether we want only unannotated
                if (onlyUnannotated) {
                    images = allImages.filter(img => {
                        const jsonFileName = img.name.replace(/\.(jpg|jpeg)$/i, '.json').toLowerCase();
                        return !existingJsonFiles.has(jsonFileName);
                    });
                    setStatus(`Loaded ${images.length} unannotated images out of ${allImages.length} total`, 'success');
                } else {
                    images = [...allImages];
                    setStatus(`Loaded all ${images.length} images`, 'success');
                }

                if (images.length > 0) {
                    currentImageIndex = 0;
                    processedImages.clear();
                    annotations = {};
                    
                    // Mark already processed images and load their annotations
                    images.forEach(img => {
                        const nameWithoutExt = img.name.replace(/\.(jpg|jpeg)$/i, '');
                        if (existingJsons.has(nameWithoutExt)) {
                            processedImages.add(img.name);
                            // Load existing annotation data
                            annotations[img.name] = existingJsons.get(nameWithoutExt);
                        }
                    });
                    
                    displayImage();
                    updateButtons();
                    updateFileList();
                    updateStats(allImages.length, totalProcessedCount);
                } else {
                    setStatus('No JPG images found in the selected folder', 'error');
                }
            } catch (err) {
                if (err.name !== 'AbortError') {
                    setStatus('Failed to load images: ' + err.message, 'error');
                }
            }
        }

        function displayImage() {
            if (images.length === 0) return;
            
            const currentImage = images[currentImageIndex];
            const reader = new FileReader();
            
            reader.onload = (e) => {
                imageViewer.src = e.target.result;
                imageViewer.style.display = 'block';
                noImageMessage.style.display = 'none';
            };
            
            reader.readAsDataURL(currentImage);
            
            currentImageName.textContent = currentImage.name;
            imageCounter.textContent = `${currentImageIndex + 1} / ${images.length}`;
            processedCounter.textContent = `Processed: ${processedImages.size}`;
            
            const imageName = currentImage.name;
            
            if (processedImages.has(imageName)) {
                processedIndicator.style.display = 'block';
                saveBtn.textContent = 'Update & Save (Enter)';
            } else {
                processedIndicator.style.display = 'none';
                saveBtn.textContent = 'Save & Mark Complete (Enter)';
            }
            
            if (annotations[imageName]) {
                textInput.value = annotations[imageName].text || '';
                dateInput.value = annotations[imageName].date || '';
            } else {
                textInput.value = '';
                dateInput.value = '';
            }
            
            updateFileList();
        }

        function updateButtons() {
            prevBtn.disabled = currentImageIndex === 0;
            nextBtn.disabled = currentImageIndex >= images.length - 1;
            saveBtn.disabled = images.length === 0;
        }

        async function saveCurrentAnnotation() {
            if (images.length === 0) return;
            
            const currentImage = images[currentImageIndex];
            const imageName = currentImage.name;
            
            const annotation = {
                text: textInput.value.trim(),
                date: dateInput.value.trim()
            };
            
            const wasProcessedBefore = processedImages.has(imageName);
            annotations[imageName] = annotation;
            processedImages.add(imageName);
            
            const jsonFileName = imageName.replace(/\.(jpg|jpeg)$/i, '.json');
            const jsonContent = JSON.stringify(annotation, null, 2);
            
            // Try to save to selected folder if available
            if (outputDirectoryHandle && 'showDirectoryPicker' in window) {
                try {
                    // Save JSON file in the same folder as images
                    const jsonFileHandle = await outputDirectoryHandle.getFileHandle(jsonFileName, { create: true });
                    const jsonWritable = await jsonFileHandle.createWritable();
                    await jsonWritable.write(jsonContent);
                    await jsonWritable.close();
                    
                    if (wasProcessedBefore) {
                        setStatus(`Updated ${jsonFileName}`, 'success');
                    } else {
                        setStatus(`Saved ${jsonFileName}`, 'success');
                    }
                } catch (err) {
                    console.error('Error saving to folder:', err);
                    downloadJSON(jsonFileName, jsonContent);
                    setStatus(`Downloaded ${jsonFileName} (couldn't save to folder)`, 'error');
                }
            } else {
                downloadJSON(jsonFileName, jsonContent);
                setStatus(`Downloaded ${jsonFileName} (no output folder selected)`, 'success');
            }
            
            // Calculate total processed count from allImages
            let totalProcessedCount = 0;
            if (allImages && allImages.length > 0) {
                allImages.forEach(img => {
                    if (processedImages.has(img.name) || annotations[img.name]) {
                        totalProcessedCount++;
                    }
                });
                updateStats(allImages.length, totalProcessedCount);
            } else {
                updateStats();
            }
            updateFileList();
            
            if (currentImageIndex < images.length - 1) {
                goToNextImage();
            } else {
                displayImage();
                updateButtons();
            }
        }

        function downloadJSON(filename, content) {
            const blob = new Blob([content], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }


        function goToPreviousImage() {
            if (currentImageIndex > 0) {
                currentImageIndex--;
                displayImage();
                updateButtons();
            }
        }

        function goToNextImage() {
            if (currentImageIndex < images.length - 1) {
                currentImageIndex++;
                displayImage();
                updateButtons();
            }
        }

        prevBtn.addEventListener('click', goToPreviousImage);
        nextBtn.addEventListener('click', goToNextImage);
        saveBtn.addEventListener('click', saveCurrentAnnotation);

        document.addEventListener('keydown', (event) => {
            // Allow Enter key to save from anywhere, including textareas
            if (event.key === 'Enter' || event.key === 'Return') {
                if (!saveBtn.disabled) {
                    event.preventDefault(); // Prevent default Enter behavior in textarea
                    saveCurrentAnnotation();
                }
                return;
            }
            
            // Skip other keyboard shortcuts when in textarea
            if (event.target.tagName === 'TEXTAREA') return;
            
            if (event.key === 'n' || event.key === 'N') {
                goToNextImage();
            } else if (event.key === 'p' || event.key === 'P') {
                goToPreviousImage();
            } else if (event.key === 's' || event.key === 'S') {
                if (!saveBtn.disabled) {
                    saveCurrentAnnotation();
                }
            }
        });

        function setStatus(message, type = '') {
            statusMessage.textContent = message;
            statusMessage.className = type;
            
            setTimeout(() => {
                statusMessage.className = '';
            }, 3000);
        }

        function updateFileList() {
            fileList.innerHTML = '';
            
            images.forEach((image, index) => {
                const li = document.createElement('li');
                li.className = 'file-item';
                
                const isProcessed = processedImages.has(image.name);
                li.classList.add(isProcessed ? 'processed' : 'unprocessed');
                
                if (index === currentImageIndex) {
                    li.classList.add('active');
                }
                
                const fileName = document.createElement('span');
                fileName.textContent = image.name.length > 25 ? 
                    image.name.substring(0, 22) + '...' : 
                    image.name;
                
                const status = document.createElement('span');
                status.className = 'file-status' + (isProcessed ? ' processed' : '');
                status.textContent = isProcessed ? '‚úì' : '‚óã';
                
                li.appendChild(fileName);
                li.appendChild(status);
                
                li.addEventListener('click', () => {
                    currentImageIndex = index;
                    displayImage();
                    updateButtons();
                    updateFileList();
                });
                
                fileList.appendChild(li);
            });
        }

        function updateStats(totalInFolder = null, processedInFolder = null) {
            // If we have folder-level stats, use those; otherwise use current view stats
            const total = totalInFolder !== null ? totalInFolder : images.length;
            const processed = processedInFolder !== null ? processedInFolder : processedImages.size;
            const remaining = total - processed;
            const progress = total > 0 ? Math.round((processed / total) * 100) : 0;
            
            statTotal.textContent = total;
            statProcessed.textContent = processed;
            statRemaining.textContent = remaining;
            statProgress.textContent = `${progress}%`;
        }
    </script>
</body>
</html>